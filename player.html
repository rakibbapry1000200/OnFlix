<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title id="pageTitle">OnFlix</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
    /* --- YouTube Style Dark Theme Variables (Standard YouTube) --- */
    :root {
        --primary-color: #ffffff; /* White for icons, primary actions in dark mode */
        --yt-red: #ff0000;
        --telegram-blue: #0088cc; /* Telegram Brand Color */
        --secondary-color: #aaaaaa; /* Lighter gray for muted text */
        --bg-color: #0f0f0f; /* Dark background (Body) */
        --card-bg: #212121; /* Dark card/header background */
        --text-color: #ffffff; /* Lightest text (White) */
        --text-muted: #aaaaaa; /* Gray muted text */
        --button-bg-light: #3f3f3f; /* Darker gray button background */
        --button-hover: #525252; /* Slightly lighter hover color */
        --link-color: #3ea6ff; /* Standard YouTube Blue for links in dark mode */
    }
    body {
        font-family: 'Roboto', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        /* üî• NEW: ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡¶ø‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ üî• */
        transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; 
    }

    /* üî• NEW: ‡¶∏‡ßç‡¶≤‡¶æ‡¶á‡¶°-‡¶°‡¶æ‡¶â‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ üî• */
    /* ‡¶™‡ßá‡¶ú ‡¶õ‡¶æ‡¶°‡¶º‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶°‡¶ø‡¶ï‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¶‡¶ø‡¶ï‡ßá ‡¶®‡¶æ‡¶Æ‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡ßá‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶™‡¶æ‡¶∏‡¶ø‡¶ü‡¶ø ‡¶ï‡¶Æ‡¶ø‡¶Ø‡¶º‡ßá ‡¶¶‡ßá‡¶¨‡ßá */
    body.slide-down-exit {
        transform: translateY(100vh); /* ‡¶™‡ßÅ‡¶∞‡ßã ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶®‡¶ø‡¶ö‡ßá ‡¶®‡ßá‡¶Æ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá */
        opacity: 0; /* ‡¶Æ‡¶ø‡¶≤‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá */
    }
    /* üî• END NEW CSS üî• */
  
    a {
        text-decoration: none;
        color: var(--text-color);
    }

    .main-content {
        max-width: 100%;
        margin: 0 auto;
        padding-bottom: 30px;
    }
  
    /* --- Video Player Container --- */
    .video-player-wrapper {
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        position: relative;
        background-color: #000;
    }
  
    .video-player-wrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
        z-index: 10;
    }

    /* Home Button Style */
    .home-button {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 30; 
        cursor: pointer;
        padding: 5px;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    .home-button:hover {
        background-color: rgba(0, 0, 0, 0.7);
    }
    .home-button svg {
        fill: var(--text-color);
        width: 24px;
        height: 24px;
    }
    /* END Home Button Style */

    /* --- Loading Spinner --- */
    .loader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9); /* Dark overlay */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20;
        flex-direction: column;
    }

    .spinner {
        border: 4px solid #3f3f3f;
        border-top: 4px solid var(--primary-color); /* White spinner top */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* --- Content Details & Title Section --- */
    .content-details {
        padding: 15px;
    }

    .content-details h1 {
        color: var(--text-color);
        font-size: 1.25em;
        font-weight: 600;
        margin: 0;
        padding: 0;
        line-height: 1.3;
        margin-bottom: 5px;
        cursor: pointer;
    }
  
    /* View Count & See More Container */
    .view-count-row {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 15px;
        min-height: 20px;
    }

    /* Used for error message alignment in this new structure */
    .view-count-row #errorMessage {
        margin-right: auto;
    }
  
    /* See More Button */
    #descriptionTrigger {
        color: var(--link-color);
        font-size: 0.85em;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: block;
        font-weight: 500;
        margin-left: auto;
    }
  
    /* --- Action Buttons --- */
    .action-bar-container {
        display: flex;
        justify-content: flex-start;
        gap: 12px;
        padding: 0;
        margin-bottom: 15px;
    }

    .action-button {
        background: var(--button-bg-light);
        border: none;
        color: var(--text-color);
        cursor: pointer;
        padding: 8px 15px;
        border-radius: 20px;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        font-size: 0.9em;
        gap: 5px;
        flex-shrink: 0;
    }
  
    /* Primary Action Buttons (Share/Download) - Inverting colors for dark mode primary action */
    #shareButton, #downloadButton {
        background-color: var(--primary-color);
        color: var(--bg-color); /* Black text on white/primary button */
    }

    /* --- Channel/Author Section --- */
    .channel-section {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border-top: 1px solid #3f3f3f; /* Dark border */
        border-bottom: 1px solid #3f3f3f; /* Dark border */
        margin-bottom: 15px;
    }

    .channel-avatar img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
        flex-shrink: 0;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1), 0 1px 2px rgba(255, 255, 255, 0.05);
    }

    .channel-info h3 {
        margin: 0;
        font-size: 1em;
        font-weight: 700;
        color: var(--text-color);
    }

    /* Best movie text style */
    #bestMovieText {
        display: block;
        margin: 0;
        font-size: 0.8em;
        color: var(--text-muted);
    }
  
    .subscribe-button {
        margin-left: auto;
        padding: 8px 15px;
        /* Use telegram-blue */
        background-color: var(--telegram-blue);
        color: #ffffff;
        font-weight: bold;
        border-radius: 20px;
        font-size: 0.9em;
        cursor: pointer;
        flex-shrink: 0;
        border: none;
        text-decoration: none;
        display: inline-block;
        line-height: 1.2;
    }

    /* Description Modal Styles (Existing) */
    .description-modal {
        position: fixed;
        bottom: 0; 
        left: 0;
        width: 100%;
        height: calc(100vh - 56.25vw); 
        max-height: 90vh; 
        background-color: var(--card-bg); 
        z-index: 2000;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        transform: translateY(100%); 
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        display: flex;
        flex-direction: column;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        will-change: transform;
    }

    .description-modal.active {
        transform: translateY(0) !important; 
    }
  
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
        padding-top: 5px;
        border-bottom: 1px solid #3f3f3f;
        flex-shrink: 0;
        min-height: 50px;
        position: relative;
    }
  
    .modal-handle {
        width: 40px;
        height: 4px;
        background-color: #606060; 
        border-radius: 2px;
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        cursor: grab;
    }
  
    .close-button {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        padding: 15px 0;
        margin-left: auto;
    }
  
    .modal-title-text {
        font-size: 1.2em;
        font-weight: 500;
        padding: 15px 0;
    }

    .modal-content {
        padding: 0 15px 15px 15px;
        flex-grow: 1;
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
    }

    .modal-content p {
        white-space: pre-wrap;
    }
  
    .modal-content a, .modal-content .hashtag {
        color: var(--link-color);
        text-decoration: none;
    }
  
    /* Title inside modal */
    #modalTitle {
        font-weight: 700;
        font-size: 1.3em;
        margin: 0;
        padding-top: 10px;
        padding-bottom: 5px;
        line-height: 1.3;
    }

    /* --- Link Copied Animation --- */
    #copyFeedback {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--primary-color);
        color: var(--bg-color);
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: 500;
        z-index: 5000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
  
    #copyFeedback.show {
        opacity: 1;
    }

    /* --- Related Videos Section --- */
    .related-videos-section, .more-videos-section, .all-videos-section { 
        padding: 0 15px;
        margin-top: 30px;
    }
  
    .related-videos-section h2, .more-videos-section h2, .all-videos-section h2 {
        font-size: 1.2em;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .related-card {
        display: flex;
        border: none;
        margin-bottom: 10px;
    }
  
    .related-card-thumbnail-container {
        width: 40%;
        max-width: 160px;
        flex-shrink: 0;
        height: 90px;
        position: relative;
    }

    .related-card-thumbnail {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 4px;
    }

    .related-card-details {
        flex-grow: 1;
        padding-left: 8px;
        min-width: 0;
    }

    .related-card-title {
        font-size: 0.9em;
        font-weight: 500;
        line-height: 1.3;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        margin-bottom: 5px;
    }
  
    .related-channel-name {
        font-size: 0.8em;
        color: var(--text-muted);
        margin: 0;
        line-height: 1.2;
        display: block;
    }
  
    /* Responsive adjustment for Related Videos list format */
    .related-video-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
  
    </style>

</head>
<body>
    <div class="main-content">
        <div class="video-player-wrapper">
            <div class="home-button" onclick="goHomeWithAnimation()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 16.41l-4.59-4.59L6 13l6 6 6-6-1.41-1.41L12 16.41zM18 4l-1.41 1.41L12 9.83 7.41 5.41 6 4l6 6 6-6z" fill="currentColor"/></svg>
            </div>
            
            <div id="videoLoader" class="loader">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 15px;">Video is loading, please wait...</p>
            </div>
            <iframe id="videoFrame" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="display:none;"></iframe>
        </div>
      
        <div class="content-details" id="contentDetails">
            <h1 id="videoTitleDisplay">Video Loading...</h1>
          
            <div class="view-count-row">
                <p id="errorMessage" style="color:var(--yt-red); display:none; font-weight:bold; margin:0;"></p>
                <button id="descriptionTrigger" style="display:none;">
                    See More
                </button>
            </div>
          
            <div class="action-bar-container">
                <button id="shareButton" class="action-button" title="Share">
                    <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                        <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5m-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"/>
                    </svg>
                    <span>Share</span>
                </button>
                <button id="downloadButton" class="action-button" title="Download">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2z"/>
                    </svg>
                    <span>Download</span>                    
                </button>
            </div>
        </div>

        <div class="channel-section">
            <div class="channel-avatar">
                <img src="https://i.ibb.co.com/Cp0xZ1T5/20251029-115303.jpg" alt="OnFlix Logo">
            </div>
            <div class="channel-info">
                <h3 id="channelName">OnFlix </h3>
                <p id="bestMovieText">Join for all latest update </p>
            </div>
            <a href="https://t.me/OnFlix_movie" target="_blank" rel="noopener noreferrer" class="subscribe-button">Join Telegram</a>
        </div>
      
        <div class="related-videos-section" style="display:none;" id="relatedVideosSection">
            <h2>Related Videos (<span id="subCategoryNameDisplay">Sub-Category</span>)</h2>
            <div class="related-video-grid" id="relatedVideoGrid">
            </div>
        </div>
      
        <div class="more-videos-section" style="display:none;" id="moreVideosSection">
            <h2>More Videos (All <span id="categoryNameDisplay">Category</span>)</h2>
            <div class="related-video-grid" id="moreVideoGrid">
            </div>
        </div>

        <div class="all-videos-section" style="display:none;" id="allVideosSection">
            <h2>All Videos (Recommended)</h2>
            <div class="related-video-grid" id="allVideoGrid">
            </div>
        </div>
    </div>
  
    <div id="copyFeedback">Link Copied!</div>

    <div id="descriptionModal" class="description-modal">
        <div class="modal-header">
            <div class="modal-handle"></div>
            <h2 class="modal-title-text">Description</h2>
            <button class="close-button" id="closeModalButton">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7a.996.996 0 1 0-1.41 1.41L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.88a.996.996 0 1 0 1.41-1.41L13.41 12l4.88-4.89c.38-.38.38-1.02 0-1.4z"/>
                </svg>
            </button>
        </div>
        <div class="modal-content" id="modalContent">
            <h3 id="modalTitle">Video Title Here</h3>
            <p id="modalDescriptionContent" style="margin-top: 10px;">No description available.</p>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBakmRixYRaHzuaR-pAUHkOJUlDG9qflJA",
            authDomain: "ad420-1780f.firebaseapp.com",
            databaseURL: "https://ad420-1780f-default-rtdb.firebaseio.com",
            projectId: "ad420-1780f",
            storageBucket: "ad420-1780f.firebasestorage.app",
            messagingSenderId: "479314410995",
            appId: "1:479314410995:web:6f7a99e1be874d69fd2686"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();
        const videosRef = database.ref('videos');
      
        // --- DOM Elements ---
        const videoFrame = document.getElementById('videoFrame');
        const videoTitleDisplay = document.getElementById('videoTitleDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const pageTitle = document.getElementById('pageTitle');
        const videoLoader = document.getElementById('videoLoader');
        
        // Related Video Sections
        const relatedVideosSection = document.getElementById('relatedVideosSection');
        const relatedVideoGrid = document.getElementById('relatedVideoGrid');
        const subCategoryNameDisplay = document.getElementById('subCategoryNameDisplay');
        
        const moreVideosSection = document.getElementById('moreVideosSection');
        const moreVideoGrid = document.getElementById('moreVideoGrid');
        const categoryNameDisplay = document.getElementById('categoryNameDisplay');

        const allVideosSection = document.getElementById('allVideosSection');
        const allVideoGrid = document.getElementById('allVideoGrid');

        const descriptionTrigger = document.getElementById('descriptionTrigger');
        const contentDetails = document.getElementById('contentDetails');
        const videoPlayerWrapper = document.querySelector('.video-player-wrapper'); 
      
        // --- Modal Elements ---
        const descriptionModal = document.getElementById('descriptionModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalTitle = document.getElementById('modalTitle');
        const modalDescriptionContent = document.getElementById('modalDescriptionContent');
        const modalHandle = document.querySelector('.modal-handle');
        const modalContent = document.getElementById('modalContent');
      
        // --- Action Elements ---
        const shareButton = document.getElementById('shareButton');
        const downloadButton = document.getElementById('downloadButton');
        const copyFeedback = document.getElementById('copyFeedback');

        // --- Globals ---
        let allVideos = [];
        let currentDescriptionHTML = 'No description available.';
      
        // --- üî• NEW: Animation for Home Navigation üî•
        function goHomeWithAnimation() {
            const body = document.body;
            // 1. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
            body.classList.add('slide-down-exit');

            // 2. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® (CSS transition 0.4s)
            setTimeout(() => {
                // 3. ‡¶π‡ßã‡¶Æ‡ßá ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                window.location.href = 'index.html';
            }, 350); // 350ms ‡¶™‡¶∞ ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶¨‡ßá, 400ms ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶ï‡¶æ‡¶õ‡¶æ‡¶ï‡¶æ‡¶õ‡¶ø‡•§
        }
        // --- END NEW Animation Logic ---
        
        // --- Utility Functions (Same as before) ---
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
      
        function createRelatedVideoCard(video) {
            const card = document.createElement('a');
            card.href = `player.html?key=${video.key}`;
            card.className = 'related-card';
            const mockChannel = 'OnFlix';
            card.innerHTML = `
                <div class="related-card-thumbnail-container">
                    <img src="${video.thumbnailURL}" alt="${video.title}" class="related-card-thumbnail" onerror="this.onerror=null;this.src='https://via.placeholder.com/160x90.png?text=Thumbnail';">
                </div>
                <div class="related-card-details">
                    <h3 class="related-card-title">${video.title}</h3>
                    <p class="related-channel-name">${mockChannel}</p>
                </div>
            `;
            return card;
        }

        function formatDescription(text) {
            let formattedText = text.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
            formattedText = formattedText.replace(/#([\w\u0980-\u09FF]+)/g, '<span class="hashtag">#$1</span>');
            formattedText = formattedText.replace(
                /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})/g,
                '<a href="mailto:$1" target="_blank" rel="noopener noreferrer">$1</a>'
            );
            const urlRegex = /(\b(?:https?:\/\/|www\.|t\.me\/)[^\s/$.?#].[^\s]*|\b[a-zA-Z0-9-]+\.(?:com|net|org|co|in|bd)\/[^\s]*)/gi;
            formattedText = formattedText.replace(
                urlRegex,
                (match) => {
                    if (match.includes('@')) return match;
                    let url = match;
                    if (!url.match(/^https?:\/\//i)) {
                         url = 'https://' + url;
                    }
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
                }
            );
            formattedText = formattedText.replace(/\n/g, '<br>');
            return formattedText;
        }
      
        // --- Modal/Description Logic (Same as before) ---
        let isDragging = false;
        let startY = 0;
        let dragY = 0;
      
        function openDescriptionModal(title, descriptionHtml) {
            modalTitle.textContent = title;
            modalDescriptionContent.innerHTML = descriptionHtml;
            descriptionModal.classList.add('active'); 
            document.body.style.overflow = 'hidden'; 
            descriptionModal.style.transform = 'translateY(0)';
        }


        function closeDescriptionModal() {
            descriptionModal.classList.remove('active');
            document.body.style.overflow = '';
            descriptionModal.style.transform = 'translateY(100%)'; 
        }

        modalHandle.addEventListener('mousedown', startDrag);
        modalHandle.addEventListener('touchstart', startDrag, { passive: true });
        
        modalContent.addEventListener('touchstart', (e) => {
            if (modalContent.scrollTop === 0 && descriptionModal.classList.contains('active')) {
                 startDrag(e);
            }
        }, { passive: true });

        function startDrag(e) {
            const isHandleOrHeader = e.target.classList.contains('modal-handle') || e.target.closest('.modal-header');
            
            if (e.type === 'touchstart' && !isHandleOrHeader && modalContent.scrollTop > 0) {
                 return; 
            }
            
            isDragging = true;
            startY = e.touches ? e.touches[0].clientY : e.clientY;
          
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
          
            descriptionModal.style.transition = 'none'; 
        }

        function onDrag(e) {
            if (!isDragging) return;
          
            const currentY = e.touches ? e.touches[0].clientY : e.clientY;
            dragY = currentY - startY;
          
            if (dragY < 0) {
                dragY = 0;
            }
          
            descriptionModal.style.transform = `translateY(${dragY}px)`;
          
            if (e.cancelable && e.type === 'touchmove') {
                e.preventDefault();
            }
        }

        function endDrag() {
            if (!isDragging) return;
          
            isDragging = false;
            descriptionModal.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)'; 
          
            if (dragY > 100) {
                closeDescriptionModal();
            } else {
                descriptionModal.style.transform = `translateY(0)`; 
            }
          
            dragY = 0;
          
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag, { passive: false });
            document.removeEventListener('touchend', endDrag);
        }

        closeModalButton.addEventListener('click', closeDescriptionModal);
      
        videoTitleDisplay.addEventListener('click', () => {
             if (currentDescriptionHTML && currentDescriptionHTML.trim().length > 0) {
                 openDescriptionModal(videoTitleDisplay.textContent, currentDescriptionHTML);
             }
        });
      
        descriptionTrigger.addEventListener('click', () => {
             if (currentDescriptionHTML && currentDescriptionHTML.trim().length > 0) {
                 openDescriptionModal(videoTitleDisplay.textContent, currentDescriptionHTML);
             }
        });
      
        // --- Share & Download Logic (Same as before) ---
        async function copyVideoLink() {
            const videoKey = getQueryParam('key');
            if (!videoKey) return;
            const videoLink = `${window.location.origin}${window.location.pathname}?key=${videoKey}`;
            try {
                if (navigator.share) {
                    await navigator.share({ title: document.title, url: videoLink });
                } else {
                    await navigator.clipboard.writeText(videoLink);
                    copyFeedback.textContent = 'Link Copied!';
                    copyFeedback.classList.add('show');
                    setTimeout(() => { copyFeedback.classList.remove('show'); }, 2000);
                }
            } catch (err) {
                console.error('Failed to share or copy text: ', err);
                copyFeedback.textContent = 'Failed to Copy!';
                copyFeedback.classList.add('show');
                setTimeout(() => { copyFeedback.classList.remove('show'); }, 2000);
            }
        }
        shareButton.addEventListener('click', copyVideoLink);

        function handleDownload(downloadUrl) {
            if (downloadUrl && downloadUrl.startsWith('http')) {
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Sorry, no download link is available for this video.');
            }
        }
      
        // --- Load Related Videos (3-Tier Logic - Same as before) ---
        function loadRelatedVideos(currentKey, currentSubCategory, currentCategory) {
            
            // 1. Reset all sections
            relatedVideoGrid.innerHTML = '';
            moreVideoGrid.innerHTML = '';
            allVideoGrid.innerHTML = '';
            relatedVideosSection.style.display = 'none';
            moreVideosSection.style.display = 'none';
            allVideosSection.style.display = 'none';

            let usedKeys = new Set([currentKey]);
            let videosForDisplay = allVideos.filter(video => video.key !== currentKey);

            // 2. Filter for Sub-Category Matches (Related Videos)
            if (currentSubCategory) {
                subCategoryNameDisplay.textContent = currentSubCategory;
                const relatedVideos = videosForDisplay.filter(video => 
                    video.subCategory && video.subCategory === currentSubCategory
                ).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                if (relatedVideos.length > 0) {
                    relatedVideos.forEach(video => { 
                        relatedVideoGrid.appendChild(createRelatedVideoCard(video));
                        usedKeys.add(video.key);
                    });
                    relatedVideosSection.style.display = 'block';
                }
            }

            // 3. Filter for Category Matches (More Videos)
            if (currentCategory) {
                categoryNameDisplay.textContent = currentCategory;
                const moreVideos = videosForDisplay.filter(video => 
                    !usedKeys.has(video.key) && video.category && video.category === currentCategory
                ).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                if (moreVideos.length > 0) {
                    moreVideos.forEach(video => { 
                        moreVideoGrid.appendChild(createRelatedVideoCard(video));
                        usedKeys.add(video.key);
                    });
                    moreVideosSection.style.display = 'block';
                }
            }
            
            // 4. Filter for All Remaining Videos (All Videos)
            const allOtherVideos = videosForDisplay.filter(video => 
                !usedKeys.has(video.key)
            ).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); // Sort by timestamp/latest

            if (allOtherVideos.length > 0) {
                 allOtherVideos.forEach(video => { 
                     allVideoGrid.appendChild(createRelatedVideoCard(video));
                 });
                 allVideosSection.style.display = 'block';
            }
        }

        // --- Core Video Load Logic (Same as before) ---
        async function loadVideoData() {
            const videoKey = getQueryParam('key');
            if (!videoKey) {
                videoLoader.style.display = 'none';
                videoTitleDisplay.textContent = 'Invalid Link';
                errorMessage.textContent = 'The link is incorrect. Please use a link with a valid video ID.';
                errorMessage.style.display = 'block';
                return;
            }
            videoLoader.style.display = 'flex';
            try {
                const allVideosSnapshot = await database.ref('videos').once('value');
                const allVideosData = allVideosSnapshot.val();
                const videosArray = [];
                let videoData = null;
                if (allVideosData) {
                    for (let key in allVideosData) {
                        if (allVideosData.hasOwnProperty(key)) {
                            const video = { key: key, ...allVideosData[key] };
                            videosArray.push(video);
                            if (key === videoKey) { videoData = video; }
                        }
                    }
                }
                allVideos = videosArray;
                if (videoData && videoData.embedLink) {
                    const title = videoData.title || 'No Title';
                    const subCategory = videoData.subCategory || '';
                    const category = videoData.category || ''; 
                    const downloadLink = videoData.downloadLink;
                    videoTitleDisplay.textContent = title;
                    const descriptionText = videoData.description || '';
                    const formattedDesc = formatDescription(descriptionText);
                    currentDescriptionHTML = formattedDesc;
                    if (descriptionText.trim().length > 0) { descriptionTrigger.style.display = 'block'; } else { descriptionTrigger.style.display = 'none'; }
                    pageTitle.textContent = title + ' | OnFlix';
                    let embedUrl = videoData.embedLink;
                    const youtubeMatch = embedUrl.match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=))([\w-]{11})/i);
                    if (youtubeMatch) { embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}?autoplay=1&rel=0&controls=1`; }
                    videoFrame.onload = function() { videoLoader.style.display = 'none'; videoFrame.style.display = 'block'; };
                    videoFrame.src = embedUrl;
                    if (downloadLink && downloadLink.startsWith('http')) {
                         downloadButton.onclick = () => handleDownload(downloadLink);
                         downloadButton.style.opacity = '1';
                         downloadButton.disabled = false;
                    } else {
                         downloadButton.onclick = () => alert('Sorry, no download link is available for this video.');
                         downloadButton.style.opacity = '0.5';
                         downloadButton.disabled = true;
                    }
                    loadRelatedVideos(videoKey, subCategory, category);
                } else {
                    videoLoader.style.display = 'none';
                    videoTitleDisplay.textContent = 'Video Load Failed';
                    errorMessage.textContent = 'No data or embed link found for this video.';
                    errorMessage.style.display = 'block';
                    pageTitle.textContent = 'Error';
                }
            } catch (error) {
                 console.error("Firebase read failed:", error);
                 videoLoader.style.display = 'none';
                 videoTitleDisplay.textContent = 'Database Error';
                 errorMessage.textContent = `Problem loading data: ${error.message}`;
                 errorMessage.style.display = 'block';
                 pageTitle.textContent = 'Error';
            }
        }
      
        loadVideoData();

    </script>

</body>
</html>